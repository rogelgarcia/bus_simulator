<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bus Sim (Prototype)</title>
    <link rel="icon" href="./favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="./src/graphics/gui/shared/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/perf_bar/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/welcome/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/setup/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/bus_select/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/map_debugger/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/connector_debugger/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/road_debugger/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/gameplay/hud.css" />
    <link rel="stylesheet" href="./src/graphics/gui/gameplay/debug_panel.css" />
    <link rel="stylesheet" href="./src/graphics/gui/rapier_debugger/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/test_mode/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/building_fabrication/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/inspector_room/styles.css" />
    <link rel="stylesheet" href="./src/graphics/gui/options/styles.css" />
</head>

<body>
<div id="game-viewport">
<canvas id="game-canvas"></canvas>

<!-- Welcome screen -->
<div id="ui-welcome" class="ui-layer">
    <div class="splash-wrap">
        <h1 class="splash-title">SIMULATION BUS</h1>
        <div class="splash-subtitle">Drive the city. Master the routes. Build your fleet.</div>
        <button id="btn-start" class="start-btn" autofocus>Press Start</button>
        <div class="hint">Enter / Space</div>
        <div class="hint">Q: Setup</div>
        <div class="hint">8: Debugs</div>
    </div>
    <div id="ui-test-errors" class="test-error-widget hidden"></div>
</div>

<div id="ui-setup" class="ui-layer hidden setup-layer">
    <div class="setup-frame" id="setup-frame">
        <div class="setup-border setup-border-top" id="setup-border-top"></div>
        <div class="setup-border setup-border-left" id="setup-border-left"></div>
        <div class="setup-panel">
            <button id="setup-collapse" class="setup-collapse-btn hidden" type="button"></button>
            <div class="setup-title">System Setup</div>
            <div class="setup-subtitle">Select a scene</div>
            <div class="setup-menu" id="setup-menu"></div>
            <div class="setup-menu setup-menu-back" id="setup-menu-back"></div>
            <div class="setup-footer">Press number, 0 (Options), Q, or click. Esc to return.</div>
        </div>
        <div class="setup-border setup-border-right" id="setup-border-right"></div>
        <div class="setup-border setup-border-bottom" id="setup-border-bottom"></div>
    </div>
</div>

<!-- Bus selection HUD -->
<div id="ui-select" class="ui-layer hidden">
    <div class="topbar">
        <div class="chip">Pick your bus</div>
    </div>
</div>

<div id="blink"></div>
</div>

<!-- Import map (so browser can resolve "three") -->
<script type="importmap">
	    {
	      "imports": {
	        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
	        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
	        "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
	        "@dimforge/rapier3d-compat": "https://cdn.skypack.dev/pin/@dimforge/rapier3d-compat@v0.19.3-Hmo5REaX4aU99UROofMk/mode=imports/optimized/@dimforge/rapier3d-compat.js",
	        "/src/": "./src/",
	        "/tests/": "./tests/"
	      }
	    }
	</script>

<script type="module" src="./src/main.js"></script>
	<script type="module">
	    const params = new URLSearchParams(window.location.search);
	    const raw = params.get('coreTests');
	    const normalized = raw === null ? null : String(raw).trim().toLowerCase();
	    const forced = normalized === null ? null : !(['0', 'false', 'no', 'off'].includes(normalized));
	    const host = String(window.location.hostname || '').toLowerCase();
	    const protocol = String(window.location.protocol || '').toLowerCase();
	    const isDevHost = (() => {
	        if (protocol === 'file:') return true;
	        if (!host) return true;
	        if (host === 'localhost' || host === '127.0.0.1' || host === '0.0.0.0' || host === '::1') return true;
	        if (host.endsWith('.localhost')) return true;

	        const m = host.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
	        if (!m) return false;
	        const a = Number(m[1]);
	        const b = Number(m[2]);
	        if (a === 10) return true;
	        if (a === 192 && b === 168) return true;
	        if (a === 172 && b >= 16 && b <= 31) return true;
	        if (a === 169 && b === 254) return true;
	        return false;
	    })();
	    const shouldRun = forced ?? isDevHost;
	    if (shouldRun) {
	        import('./tests/core.test.js').catch((err) => {
	            console.error('[CoreTests] Failed to load tests/core.test.js', err);
	            const message = err?.message ?? String(err);
	            if (!Array.isArray(window.__testFatals)) window.__testFatals = [];
	            window.__testFatals.push({ name: 'CoreTests', message });
	            window.__coreTestsFailed = 1;
	            window.__coreTestsDone = true;
	        });
	    }
	</script>
</body>
</html>
